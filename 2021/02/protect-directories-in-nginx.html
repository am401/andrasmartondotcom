<!DOCTYPE html>
<html lang="en">
    <head>
        <title>protect directories in nginx</title>
        <link rel="stylesheet" href="style.css?v=1.0.2">
	    <meta charset="UTF-8">
	    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    </head>
    <body>
        <div class="heading">
            www.placeonthe.net - my website
			<div class="heading-right">
				<a href="/index.html">&#126;&#47;</a> |
				<a href="#ctf">ctf</a> |
				<a href="#projects">projects</a>
			</div>
        </div>
        <div class="text">
		<h1>protect directories in nginx</h1>
		<h2>Written: 2020/12/31</h2>
<p>I've recently had a number of requests for custom NGINX rules to be created in order to protect WordPress upload directories. This scenario may surface if you are using NGINX as your primary web server or NGINX sits before say an upstream Apache server and the <strong>.htaccess</strong> files is not an option. I have recently configured several rules to protect directories.<br>The following rule is specifically for static files, such as PDFs:</p>

<pre class="wp-block-code"><code>if ( $uri ~* ^/wp-content/uploads/.+\.pdf$ ) {
    set $var 1;
}
if ( $http_cookie !~* wordpress_logged_in ) {
    set $var "${var}1";
}
if ( $var = 11 ) {
    return 403;
}</code></pre>

<p>The above rule works on by checking if the incoming request URI is looking for PDF files within <strong>/wp-content/uploads/</strong> and if so whether the <strong>wordpress_logged_in</strong> cookie is set. If it is not then return the a <strong>HTTP 403</strong> response. Since <a href="https://www.nginx.com/resources/wiki/start/topics/depth/ifisevil/">NGINX does not use <strong>if/else</strong> statements</a>, we build out our rule using several <strong>if</strong> statements.</p>

<p>Another example we can use is the following, which uses a location block to achieve similar:</p>

<pre class="wp-block-code"><code>location ~* ^/wp-content/uploads/protected/(?!public_images/).+\.jpg$ {
    add_header Cache-Control "no-store; max-age=0";
    if ( $http_cookie !~* wordpress_logged_in ) {
        return 403;
    }
}</code></pre>

<p>The above again uses a very similar process, however this time using a <strong>location block</strong>. The reason behind using a <strong>location block</strong> is since we are handling JPG files in this examples, we do not want additional caching layers to cache these when a logged in user views them. Since we want to alter the behavior of the JPG files in this specification path only, to remove pre-existing configurations, we carve out a <strong>location block</strong> and pass back the <strong>Cache-Control</strong> header. By setting the <strong>no-store</strong> argument, it tells caching applications not to store the response on cache. By reducing the <strong>max-age</strong> to zero, we also force browsers to check the header each time.</p>

<p>As an added feature, in this example I have implemented a <strong>negative lookahead</strong> in order to ignore images found in the <strong>public_images</strong> directory, which we want users who have not logged in to be able to access.</p>


          </div>
    </body>
</html>
